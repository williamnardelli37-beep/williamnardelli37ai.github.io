<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>M&A Caixa</title>
    <style>
        /* Estilos CSS */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #15325d;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #15325d;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .header-bar button {
            background-color: #183774;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .header-bar button:hover {
            background-color: #0056b3;
        }
        .total-do-dia {
            font-size: 1.2rem;
            font-weight: bold;
            color: #dfdfdf;
        }
        .container {
            flex: 1;
            display: flex;
            padding: 10px;
        }
        .page {
            display: none;
            width: 100%;
            height: 100%;
        }
        .page.active {
            display: flex;
        }
        .caixa-main {
            flex: 2;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            margin-right: 10px;
            overflow: hidden;
        }
        .caixa-sidebar {
            flex: 1;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .quick-values {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            max-height: 40%;
            overflow-y: auto;
        }
        .quick-value-button {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            flex: 1 1 20%;
            min-width: 60px;
            text-align: center;
        }
        .input-valor {
            width: 100%;
            padding: 10px;
            font-size: 2rem;
            text-align: right;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .cart-list, .history-list, .saques-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-price {
            font-weight: bold;
        }
        .cart-item-remove {
            background: none;
            border: none;
            color: #183774;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .cart-summary {
            border-top: 2px solid #eee;
            padding-top: 10px;
        }
        .cart-summary .total {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-weight: bold;
            color: #218838;
        }
        .payment-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .payment-button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 0.9rem;
            flex-grow: 1;
            margin: 0 4px;
        }
        .payment-button.active {
            background-color: #2b5179;
            color: #fff;
            border-color: #2b5179;
        }
        .checkout-button {
            width: 100%;
            padding: 12px;
            background-color: #167479;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .checkout-button:hover {
            background-color: #167479;
        }
        .history-main {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .history-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap; 
            gap: 8px;
        }
        .history-actions button {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #iniciarTurnoBtn { background-color: #167479; }
        #finalizarTurnoBtn { background-color: #183774; }
        #baixarHistoricoBtn, #verHistoricoCompletoBtn { background-color: #007bff; }
        #excluirUltimaVendaBtn { background-color: #dc3545; } 
        #filterPixBtn, #filterOntemBtn { background-color: #6c757d; }
        #filterPixBtn.active, #filterOntemBtn.active { background-color: #183774; }

        .history-item, .saque-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .history-item.hidden {
            display: none;
        }
        .history-item-info span, .saque-item span {
            display: block;
            color: #666;
        }
        .turno-status {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
        }
        /* Estilos para o Modal (Pop-up) */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3, .modal-content p {
            margin: 0 0 10px 0;
        }
        .modal-content h3 {
            font-size: 1.5rem;
        }
        .modal-content .valor-display {
            font-size: 2rem;
            font-weight: bold;
            color: #2b5179;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            font-size: 1.5rem;
            text-align: right;
            border: 1px solid #2f4180;
            border-radius: 8px;
            box-sizing: border-box;
            margin: 10px 0;
        }
        .modal-content .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .modal-content .modal-buttons button {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
            margin: 0 5px;
        }
        #finalizarTrocoBtn, #finalizarPixBtn { background-color: #167479; color: #fff; border: none; }
        #finalizarTrocoBtn:hover, #finalizarPixBtn:hover { background-color: #167479; }
        #cancelarTrocoBtn, #cancelarPixBtn { background-color: #183774; color: #fff; border: none; }
        #cancelarTrocoBtn:hover, #cancelarPixBtn:hover { background-color: #183774; }
        #exatoBtn { background-color: #6c757d; color: #fff; border: none; }
        #exatoBtn:hover { background-color: #5a6268; }
        .saque-section {
            display: flex;
            flex-direction: column;
            margin-top: 15px;
        }
        .saque-section h2 {
            font-size: 1.2rem;
            margin-top: 0;
        }
        .saque-section .total {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            font-weight: bold;
            color: #183774;
        }
        .history-section {
            margin-top: 15px;
        }
        .historico-completo {
            display: none;
            margin-top: 15px;
        }
        .turno-historico {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .turno-historico h4 {
            margin: 0 0 5px 0;
        }
        .turno-historico li {
            list-style: none;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        #showHideHistoryBtn {
            background-color: #6c757d;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            margin-top: 10px;
            display: none; 
        }
        #longTurnoWarning {
            background-color: #ffc107;
            color: #333;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none; /* Inicialmente oculto */
        }
        #qrcodeDisplay img {
             max-width: 100%;
             height: auto;
        }
    </style>
</head>
<body>

    <div id="longTurnoWarning">Seu turno está com mais de 11 horas. Considere finalizá-lo.</div>

    <div class="header-bar">
        <button onclick="showPage('caixa')">Caixa</button>
        <button onclick="showPage('historico')">Histórico</button>
        <div class="total-do-dia">Total do Turno: <span id="totalDoDia">R$ 0,00</span></div>
    </div>

    <div id="caixa" class="page active container">
        <div class="caixa-main">
            <div class="quick-values" id="quickValues"></div>
            <input type="text" id="valorInput" class="input-valor" placeholder="0,00" value="0,00">
            <button id="adicionarButton" class="checkout-button" style="background-color: #167479; margin-top: 0;">Adicionar</button>
            
            <div class="saque-section">
                <h2>Retirada de Caixa (Sangria)</h2>
                <input type="text" id="saqueInput" class="input-valor" placeholder="0,00" value="0,00">
                <button id="saqueButton" class="checkout-button" style="background-color: #183774;">Registrar Saque</button>
            </div>
        </div>
        
        <div class="caixa-sidebar">
            <h2 style="font-size: 1.2rem; margin-top: 0;">Transação</h2>
            <div id="cartList" class="cart-list"></div>
            <div class="cart-summary">
                <div class="total">
                    <span>Total:</span>
                    <span id="cartTotal">R$ 0,00</span>
                </div>
                <div class="payment-buttons">
                    <button class="payment-button active" data-type="Dinheiro">Dinheiro</button>
                    <button class="payment-button" data-type="Cartão">Cartão</button>
                    <button class="payment-button" data-type="PIX">PIX</button>
                </div>
                <button id="finalizarButton" class="checkout-button">Finalizar Venda</button>
            </div>
        </div>
    </div>

    <div id="historico" class="page container">
        <div class="history-main">
            <div class="history-actions">
                <button id="iniciarTurnoBtn" style="background-color: #167479;">Iniciar Turno</button>
                <button id="finalizarTurnoBtn" style="background-color: #183774;">Finalizar Turno</button>
            </div>
            
            <div class="history-actions" style="margin-bottom: 20px;">
                <button id="filterPixBtn">Mostrar Apenas **PIX**</button>
                <button id="filterOntemBtn">Mostrar **Ontem** (Turnos Anteriores)</button>
                <button id="excluirUltimaVendaBtn">Excluir Última Venda</button>
            </div>
            
            <div class="turno-status">Turno iniciado: <span id="turnoStartTime">N/A</span> | Tempo de trabalho: <span id="workTime">00:00:00</span></div>

            <div class="history-section">
                <h2 style="font-size: 1.2rem; margin-top: 0;">Histórico de Vendas</h2>
                <div id="historyList" class="history-list"></div>
                <button id="showHideHistoryBtn">Mostrar mais</button>
                <div class="total-historico">
                    <h3 style="font-size: 1rem;">Total de Vendas: <span id="totalHistorico">R$ 0,00</span></h3>
                </div>
            </div>

            <div class="saque-section">
                <h2>Histórico de Saques</h2>
                <div id="saquesList" class="saques-list"></div>
                <div class="total">
                    <span>Total de Saques:</span>
                    <span id="totalSaques">R$ 0,00</span>
                </div>
            </div>

            <div class="history-actions" style="justify-content: center; margin-top: 20px;">
                <button id="baixarHistoricoBtn" style="background-color: #183774; margin-right: 10px;">Baixar Histórico (Turno Atual)</button>
                <button id="baixarPixOntemBtn" style="background-color: #167479; margin-right: 10px;">Baixar Relatório PIX Ontem</button>
                <button id="verHistoricoCompletoBtn">Ver Histórico Completo</button>
            </div>

            <div id="historicoCompleto" class="historico-completo">
                <h2>Todos os Turnos Finalizados</h2>
                <div id="historicoCompletoList"></div>
            </div>
        </div>
    </div>

    <div id="trocoModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Calcular Troco</h3>
            <p>Total da venda: <span class="valor-display" id="modalTotal">R$ 0,00</span></p>
            <p>Valor recebido:</p>
            <input type="text" id="valorRecebidoInput" placeholder="0,00">
            <div class="modal-buttons">
                <button id="exatoBtn">Exato</button>
                <button id="finalizarTrocoBtn">Finalizar</button>
            </div>
            <p style="margin-top: 10px;">Troco: <span class="valor-display" id="modalTroco">R$ 0,00</span></p>
            <button id="cancelarTrocoBtn" style="margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <div id="pixModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 300px;">
            <h3>Pagamento PIX</h3>
            <div id="qrcodeDisplay" style="width:100%; display: flex; justify-content: center; margin: 10px 0;">
                </div>
            <p>Valor a pagar:</p>
            <span class="valor-display" id="pixValorDisplay">R$ 0,00</span>
            <p style="font-size: 0.9rem; margin-top: 10px;">Chave PIX (CNPJ):</p>
            <p style="font-size: 1.1rem; font-weight: bold; color: #167479;">09.127.957/0001-78</p>
            <button id="finalizarPixBtn" class="checkout-button" style="background-color: #167479;">Pagamento Confirmado</button>
            <button id="cancelarPixBtn" class="checkout-button" style="background-color: #183774; margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <script>
        let carrinho = [];
        let historicoTurno = [];
        let saquesTurno = [];
        let historicoCompleto = [];
        let tipoPagamento = 'Dinheiro';
        let turnoStartTime = null;
        let workTimeInterval;
        let historicoVisivel = false;
        let filtroPixAtivo = false;
        let filtroOntemAtivo = false;
        let historicoFiltrado = []; 
        let longTurnoWarningTimeout; 
        // MODIFICAÇÃO CHAVE: Flag para garantir que o aviso só apareça uma vez por turno
        let longTurnoWarningShown = false; 

        // CONSTANTES PIX 
        const PIX_KEY = '09127957000178'; 
        const PIX_NAME = 'RAIZ CULTURAL LTDA'; 
        const PIX_CITY = 'CAXIAS DO SUL'; 

        // Seletores de elementos HTML (omitidos para brevidade, mas devem estar completos)
        const PIX_MODAL = document.getElementById('pixModal');
        const PIX_VALOR_DISPLAY = document.getElementById('pixValorDisplay');
        const QRCODE_DISPLAY = document.getElementById('qrcodeDisplay');
        const FINALIZAR_PIX_BTN = document.getElementById('finalizarPixBtn');
        const CANCELAR_PIX_BTN = document.getElementById('cancelarPixBtn');
        const pages = document.querySelectorAll('.page');
        const valorInput = document.getElementById('valorInput');
        const adicionarButton = document.getElementById('adicionarButton');
        const cartList = document.getElementById('cartList');
        const cartTotal = document.getElementById('cartTotal');
        const finalizarButton = document.getElementById('finalizarButton');
        const paymentButtons = document.querySelectorAll('.payment-button');
        const quickValuesContainer = document.getElementById('quickValues');
        const historyList = document.getElementById('historyList');
        const saquesList = document.getElementById('saquesList');
        const totalSaquesSpan = document.getElementById('totalSaques');
        const totalHistoricoSpan = document.getElementById('totalHistorico');
        const totalDoDiaSpan = document.getElementById('totalDoDia');
        const iniciarTurnoBtn = document.getElementById('iniciarTurnoBtn');
        const finalizarTurnoBtn = document.getElementById('finalizarTurnoBtn');
        const baixarHistoricoBtn = document.getElementById('baixarHistoricoBtn');
        const verHistoricoCompletoBtn = document.getElementById('verHistoricoCompletoBtn');
        const historicoCompletoDiv = document.getElementById('historicoCompleto');
        const historicoCompletoList = document.getElementById('historicoCompletoList');
        const turnoStartTimeSpan = document.getElementById('turnoStartTime');
        const workTimeSpan = document.getElementById('workTime');
        const trocoModal = document.getElementById('trocoModal');
        const modalTotalSpan = document.getElementById('modalTotal');
        const valorRecebidoInput = document.getElementById('valorRecebidoInput');
        const modalTrocoSpan = document.getElementById('modalTroco');
        const exatoBtn = document.getElementById('exatoBtn');
        const finalizarTrocoBtn = document.getElementById('finalizarTrocoBtn');
        const cancelarTrocoBtn = document.getElementById('cancelarTrocoBtn');
        const saqueInput = document.getElementById('saqueInput');
        const saqueButton = document.getElementById('saqueButton');
        const showHideHistoryBtn = document.getElementById('showHideHistoryBtn');
        const longTurnoWarning = document.getElementById('longTurnoWarning');
        const filterPixBtn = document.getElementById('filterPixBtn');
        const filterOntemBtn = document.getElementById('filterOntemBtn');
        const excluirUltimaVendaBtn = document.getElementById('excluirUltimaVendaBtn');
        const baixarPixOntemBtn = document.getElementById('baixarPixOntemBtn');

        const quickValues = [1.50, 2, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];

        // [Funções de Utilidade, LocalStorage, PIX OMITIDAS AQUI POR BREVIDADE]

        function setCursorPosition(input) {
            input.selectionStart = input.selectionEnd = input.value.length;
        }

        valorInput.addEventListener('click', function() {
            setCursorPosition(this);
        });
        saqueInput.addEventListener('click', function() {
            setCursorPosition(this);
        });

        function saveState() {
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            localStorage.setItem('historicoTurno', JSON.stringify(historicoTurno));
            localStorage.setItem('saquesTurno', JSON.stringify(saquesTurno));
            localStorage.setItem('historicoCompleto', JSON.stringify(historicoCompleto));
            localStorage.setItem('turnoStartTime', turnoStartTime);
        }

        function loadState() {
            const savedCarrinho = localStorage.getItem('carrinho');
            const savedHistoricoTurno = localStorage.getItem('historicoTurno');
            const savedSaquesTurno = localStorage.getItem('saquesTurno');
            const savedHistoricoCompleto = localStorage.getItem('historicoCompleto');
            const savedTurnoStartTime = localStorage.getItem('turnoStartTime');

            if (savedCarrinho) {
                carrinho = JSON.parse(savedCarrinho);
            }
            if (savedHistoricoTurno) {
                historicoTurno = JSON.parse(savedHistoricoTurno);
            }
            if (savedSaquesTurno) {
                saquesTurno = JSON.parse(savedSaquesTurno);
            }
            if (savedHistoricoCompleto) {
                historicoCompleto = JSON.parse(savedHistoricoCompleto);
            }
            if (savedTurnoStartTime !== 'null') {
                turnoStartTime = savedTurnoStartTime;
                startWorkTimeCounter();
            }
        }
        
        function crc16CCITT(payload) {
            const polynomial = 0x1021;
            let crc = 0xFFFF;
            const payloadBytes = payload.split('').map(char => char.charCodeAt(0) & 0xFF); 

            for (let i = 0; i < payloadBytes.length; i++) {
                crc ^= (payloadBytes[i] << 8);
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x8000) {
                        crc = (crc << 1) ^ polynomial;
                    } else {
                        crc = (crc << 1);
                    }
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }

        function generatePixPayload(valor) {
            const normalizeString = (str) => {
                return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
            }

            const name = normalizeString(PIX_NAME).substring(0, 25);
            const city = normalizeString(PIX_CITY).substring(0, 15);
            const value = valor.toFixed(2);
            const txid = '***'; 

            const tlv = (id, value) => {
                const length = value.length.toString().padStart(2, '0');
                return `${id.toString().padStart(2, '0')}${length}${value}`;
            };

            let payloadBase = '';
            payloadBase += tlv(0, '01');       
            payloadBase += tlv(1, '12');       
            
            const maiContent = tlv(0, 'BR.GOV.BCB.PIX') +
                               tlv(1, PIX_KEY) +          
                               tlv(2, txid);             
            
            payloadBase += tlv(26, maiContent); 

            payloadBase += tlv(52, '0000');    
            payloadBase += tlv(53, '986');    
            payloadBase += tlv(54, value);     
            payloadBase += tlv(58, 'BR');      
            payloadBase += tlv(59, name);      
            payloadBase += tlv(60, city);      
            payloadBase += tlv(62, tlv(5, txid));      

            const payloadCRC = payloadBase + '6304'; 
            const crc = crc16CCITT(payloadCRC);

            return payloadCRC + crc;
        }


        // =================================================================
        // FUNÇÃO DE TEMPO CORRIGIDA
        // =================================================================

        function updateWorkTime() {
            if (turnoStartTime) {
                const now = new Date().getTime();
                const diff = now - parseInt(turnoStartTime);
                const seconds = Math.floor(diff / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;

                const pad = (num) => num.toString().padStart(2, '0');
                workTimeSpan.textContent = `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;

                // AVISO DE TURNO LONGO: Checa se excedeu 11h E se AINDA não foi mostrado
                if (seconds > (11 * 3600) && !longTurnoWarningShown) {
                    
                    // 1. Marca como mostrado para que NUNCA MAIS apareça neste turno
                    longTurnoWarningShown = true; 
                    
                    // 2. Mostra a mensagem
                    longTurnoWarning.style.display = 'block';
                    
                    // 3. Agenda a remoção após 2 segundos
                    longTurnoWarningTimeout = setTimeout(() => {
                        longTurnoWarning.style.display = 'none';
                        longTurnoWarningTimeout = null; 
                    }, 2000); 
                } 
                
                // 4. Se estiver com menos de 11 horas, garante que qualquer timeout pendente seja cancelado
                if (seconds <= (11 * 3600) && longTurnoWarningTimeout) {
                    clearTimeout(longTurnoWarningTimeout);
                    longTurnoWarning.style.display = 'none';
                    longTurnoWarningTimeout = null; 
                }
            }
        }

        function startWorkTimeCounter() {
            clearInterval(workTimeInterval);
            turnoStartTimeSpan.textContent = new Date(parseInt(turnoStartTime)).toLocaleString('pt-BR');
            workTimeInterval = setInterval(updateWorkTime, 1000);
        }

        function stopWorkTimeCounter() {
            clearInterval(workTimeInterval);
            workTimeSpan.textContent = '00:00:00';
            turnoStartTimeSpan.textContent = 'N/A';
            longTurnoWarning.style.display = 'none';
            if (longTurnoWarningTimeout) {
                 clearTimeout(longTurnoWarningTimeout);
            }
        }

        // =================================================================
        // LISTENERS DE AÇÃO
        // =================================================================

        quickValues.forEach(valor => {
            const button = document.createElement('button');
            button.className = 'quick-value-button';
            button.textContent = `R$ ${valor.toFixed(2).replace('.', ',')}`;
            button.addEventListener('click', () => {
                let valorAtual = parseFloat(valorInput.value.replace(',', '.')) || 0;
                valorAtual += valor;
                valorInput.value = valorAtual.toFixed(2).replace('.', ',');
            });
            quickValuesContainer.appendChild(button);
        });

        adicionarButton.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Por favor, inicie um turno antes de adicionar vendas.");
                return;
            }
            let valor = parseFloat(valorInput.value.replace(',', '.'));
            if (isNaN(valor) || valor <= 0) {
                alert("Por favor, insira um valor válido.");
                return;
            }
            carrinho.push(valor);
            renderizarCarrinho();
            valorInput.value = '0,00';
            saveState(); 
        });

        paymentButtons.forEach(button => {
            button.addEventListener('click', () => {
                paymentButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tipoPagamento = button.dataset.type;
            });
        });

        finalizarButton.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Por favor, inicie um turno antes de finalizar vendas.");
                return;
            }
            if (carrinho.length === 0) {
                alert("O carrinho está vazio. Adicione itens para finalizar a venda.");
                return;
            }

            const total = carrinho.reduce((sum, item) => sum + item, 0);

            if (tipoPagamento === 'Dinheiro') {
                modalTotalSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                valorRecebidoInput.value = '';
                modalTrocoSpan.textContent = `R$ 0,00`;
                trocoModal.style.display = 'flex';
                valorRecebidoInput.focus();
            } else if (tipoPagamento === 'PIX') {
                PIX_VALOR_DISPLAY.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                const pixPayload = generatePixPayload(total);
                QRCODE_DISPLAY.innerHTML = ''; 
                new QRCode(QRCODE_DISPLAY, {
                    text: pixPayload,
                    width: 250,
                    height: 250,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                PIX_MODAL.style.display = 'flex';
            } else {
                finalizarVendaReal();
            }
        });
        
        valorRecebidoInput.addEventListener('input', (e) => {
            let valorRecebido = parseFloat(e.target.value.replace(',', '.')) || 0;
            const total = parseFloat(cartTotal.textContent.replace('R$ ', '').replace(',', '.'));
            const troco = valorRecebido - total;
            modalTrocoSpan.textContent = `R$ ${troco.toFixed(2).replace('.', ',')}`;
        });

        exatoBtn.addEventListener('click', () => {
            const total = parseFloat(cartTotal.textContent.replace('R$ ', '').replace(',', '.'));
            valorRecebidoInput.value = total.toFixed(2).replace('.', ',');
            modalTrocoSpan.textContent = `R$ 0,00`;
        });

        finalizarTrocoBtn.addEventListener('click', () => {
            const valorRecebido = parseFloat(valorRecebidoInput.value.replace(',', '.'));
            const total = parseFloat(cartTotal.textContent.replace('R$ ', '').replace(',', '.'));
            if (isNaN(valorRecebido) || valorRecebido < total) {
                alert("O valor recebido é inválido ou menor que o total. Por favor, corrija.");
                return;
            }
            finalizarVendaReal();
            trocoModal.style.display = 'none';
        });

        cancelarTrocoBtn.addEventListener('click', () => {
            trocoModal.style.display = 'none';
        });

        FINALIZAR_PIX_BTN.addEventListener('click', () => {
            finalizarVendaReal();
            PIX_MODAL.style.display = 'none';
        });

        CANCELAR_PIX_BTN.addEventListener('click', () => {
            PIX_MODAL.style.display = 'none';
        });

        saqueButton.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Por favor, inicie um turno antes de registrar um saque.");
                return;
            }
            let valorSaque = parseFloat(saqueInput.value.replace(',', '.'));
            if (isNaN(valorSaque) || valorSaque <= 0) {
                alert("Por favor, insira um valor de saque válido.");
                return;
            }
            const dataSaque = new Date().toLocaleString('pt-BR');
            saquesTurno.push({ valor: valorSaque, data: dataSaque });
            saqueInput.value = '0,00';
            renderizarSaques();
            saveState(); 
            alert(`Saque de R$ ${valorSaque.toFixed(2).replace('.', ',')} registrado com sucesso.`);
        });
        
        function finalizarVendaReal() {
            const total = carrinho.reduce((sum, item) => sum + item, 0);
            const dataVenda = new Date().toLocaleString('pt-BR');
            const idVenda = historicoTurno.length + 1; 
            const transacao = { id: idVenda, total, pagamento: tipoPagamento, data: dataVenda };
            historicoTurno.push(transacao);
            carrinho = [];
            renderizarCarrinho();
            atualizarTotalDoDia();
            renderizarHistorico(); 
            saveState(); 
            alert(`Venda finalizada com sucesso!\nTotal: R$ ${total.toFixed(2).replace('.', ',')}\nPagamento: ${tipoPagamento}`);
        }

        // Listener de Iniciar Turno (Incluindo reset da flag)
        iniciarTurnoBtn.addEventListener('click', () => {
            if (turnoStartTime) {
                alert("Já existe um turno em andamento. Finalize o turno atual para iniciar um novo.");
                return;
            }
            historicoTurno = [];
            saquesTurno = [];
            turnoStartTime = new Date().getTime();
            
            // MODIFICAÇÃO: Zera a flag do aviso de turno longo para o novo turno
            longTurnoWarningShown = false; 
            
            saveState(); 
            startWorkTimeCounter();
            alert("Novo turno iniciado! O caixa foi zerado.");
            filtroPixAtivo = false;
            filtroOntemAtivo = false;
            filterPixBtn.classList.remove('active');
            filterOntemBtn.classList.remove('active');
            renderizarHistorico();
            renderizarSaques();
            atualizarTotalDoDia();
        });

        finalizarTurnoBtn.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Nenhum turno em andamento para finalizar.");
                return;
            }
            const totalVendasTurno = historicoTurno.reduce((sum, transacao) => sum + transacao.total, 0);
            const totalSaquesTurno = saquesTurno.reduce((sum, saque) => sum + saque.valor, 0);
            
            const dataFimTurno = new Date().getTime();
            
            historicoCompleto.unshift({
                data: new Date(dataFimTurno).toLocaleString('pt-BR'),
                dataInicioMS: parseInt(turnoStartTime),
                dataFimMS: dataFimTurno,
                totalVendas: totalVendasTurno,
                totalSaques: totalSaquesTurno,
                vendas: [...historicoTurno],
                saques: [...saquesTurno]
            });
            alert(`Turno finalizado! Total de vendas do turno: R$ ${totalVendasTurno.toFixed(2).replace('.', ',')}.\nTotal de saques: R$ ${totalSaquesTurno.toFixed(2).replace('.', ',')}.`);
            
            historicoTurno = [];
            saquesTurno = [];
            turnoStartTime = null;
            saveState(); 
            stopWorkTimeCounter();
            renderizarHistorico();
            renderizarSaques();
            atualizarTotalDoDia();
        });

        excluirUltimaVendaBtn.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Nenhum turno em andamento.");
                return;
            }
            if (historicoTurno.length === 0) {
                alert("Não há vendas para excluir no histórico atual.");
                return;
            }

            const ultimaVenda = historicoTurno[historicoTurno.length - 1];
            
            if (confirm(`Tem certeza que deseja EXCLUIR a última venda (ID: ${ultimaVenda.id || 'N/A'}, R$ ${ultimaVenda.total.toFixed(2).replace('.', ',')} - ${ultimaVenda.pagamento})? Esta ação é irreversível neste turno.`)) {
                historicoTurno.pop();
                renderizarHistorico();
                atualizarTotalDoDia();
                saveState();
                alert(`Última venda excluída com sucesso!`);
            }
        });

        baixarPixOntemBtn.addEventListener('click', () => {
            if (historicoCompleto.length === 0) {
                alert("Não há turnos finalizados para verificar o histórico de ontem.");
                return;
            }
            
            const ultimoTurno = historicoCompleto[0];
            
            if (!ultimoTurno || ultimoTurno.vendas.length === 0) {
                 alert("O último turno finalizado não contém vendas.");
                 return;
            }
            
            const pixVendasOntem = ultimoTurno.vendas.filter(venda => venda.pagamento === 'PIX');

            if (pixVendasOntem.length === 0) {
                alert(`Não houve vendas PIX no turno finalizado em ${ultimoTurno.data.split(' ')[0]}.`);
                return;
            }

            const totalPixOntem = pixVendasOntem.reduce((sum, venda) => sum + venda.total, 0);

            let csvContent = "data:text/csv;charset=utf-8,";
            
            csvContent += `Relatório PIX do Turno Finalizado em: ${ultimoTurno.data.split(' ')[0]}\n`;
            csvContent += `"Quantidade de Vendas PIX","${pixVendasOntem.length}"\n`;
            csvContent += `"Total de Vendas PIX","${totalPixOntem.toFixed(2).replace('.', ',')}"\n\n`;

            csvContent += "Tipo,Data e Hora,Valor\n";

            pixVendasOntem.forEach(transacao => {
                const row = [`"Venda PIX"`, `"${transacao.data}"`, `"${transacao.total.toFixed(2).replace('.', ',')}"`].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `relatorio_pix_${ultimoTurno.data.split(' ')[0].replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        baixarHistoricoBtn.addEventListener('click', () => {
            if (historicoTurno.length === 0 && saquesTurno.length === 0) {
                alert("Não há histórico para baixar.");
                return;
            }
            
            const totalVendasTurno = historicoTurno.reduce((sum, transacao) => sum + transacao.total, 0);
            const totalSaquesTurno = saquesTurno.reduce((sum, saque) => sum + saque.valor, 0);
            const quantidadeVendas = historicoTurno.length;
            const valorFinalCaixa = totalVendasTurno - totalSaquesTurno;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            csvContent += "Resumo do Turno\n";
            csvContent += `"Quantidade de Vendas","${quantidadeVendas}"\n`;
            csvContent += `"Total de Vendas","${totalVendasTurno.toFixed(2).replace('.', ',')}"\n`;
            csvContent += `"Total de Saques","${totalSaquesTurno.toFixed(2).replace('.', ',')}"\n`;
            csvContent += `"Valor Final (Vendas - Saques)","${valorFinalCaixa.toFixed(2).replace('.', ',')}"\n\n`;

            csvContent += "Tipo,Data e Hora,Valor,Forma de Pagamento\n";

            historicoTurno.forEach(transacao => {
                const row = [`"Venda"`, `"${transacao.data}"`, `"${transacao.total.toFixed(2).replace('.', ',')}"`, `"${transacao.pagamento}"`].join(",");
                csvContent += row + "\n";
            });

            saquesTurno.forEach(saque => {
                const row = [`"Saque"`, `"${saque.data}"`, `"${saque.valor.toFixed(2).replace('.', ',')}"`, `""`].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historico_turno_atual.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        verHistoricoCompletoBtn.addEventListener('click', () => {
            if (historicoCompleto.length === 0) {
                alert("Não há histórico de turnos finalizados.");
                return;
            }
            historicoCompletoDiv.style.display = 'block';
            historicoCompletoList.innerHTML = '';
            historicoCompleto.forEach(turno => {
                const divTurno = document.createElement('div');
                divTurno.className = 'turno-historico';
                divTurno.innerHTML = `
                    <h4>Turno de ${turno.data}</h4>
                    <p>Total de Vendas: R$ ${turno.totalVendas.toFixed(2).replace('.', ',')}</p>
                    <p>Total de Saques: R$ ${turno.totalSaques.toFixed(2).replace('.', ',')}</p>
                    <ul>
                        ${turno.vendas.map(venda => `<li>Venda (${venda.pagamento}): R$ ${venda.total.toFixed(2).replace('.', ',')}</li>`).join('')}
                    </ul>
                    <ul>
                        ${turno.saques.map(saque => `<li>Saque: R$ ${saque.valor.toFixed(2).replace('.', ',')}</li>`).join('')}
                    </ul>
                `;
                historicoCompletoList.appendChild(divTurno);
            });
        });

        // [Funções de Renderização OMITIDAS AQUI POR BREVIDADE]
        function renderizarCarrinho() {
            cartList.innerHTML = '';
            let total = 0;
            if (carrinho.length === 0) {
                cartList.innerHTML = '<p style="text-align: center; color: #888; font-size: 0.9rem;">Carrinho vazio</p>';
            } else {
                carrinho.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'cart-item';
                    listItem.innerHTML = `
                        <span class="cart-item-price">R$ ${item.toFixed(2).replace('.', ',')}</span>
                        <button class="cart-item-remove" data-index="${index}">×</button>
                    `;
                    cartList.appendChild(listItem);
                    total += item;
                });
                document.querySelectorAll('.cart-item-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = e.target.getAttribute('data-index');
                        carrinho.splice(index, 1);
                        renderizarCarrinho();
                        saveState();
                    });
                });
            }
            cartTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function renderizarHistorico() {
            historyList.innerHTML = '';
            let totalHistorico = 0;
            
            let dadosParaRenderizar = historicoTurno;
            
            if (filtroOntemAtivo && historicoCompleto.length > 0) {
                dadosParaRenderizar = historicoCompleto[0].vendas;
            } else if (filtroOntemAtivo && historicoCompleto.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #dc3545; font-size: 0.9rem;">Não há turnos finalizados para mostrar "Ontem".</p>';
                totalHistoricoSpan.textContent = `R$ 0,00`;
                showHideHistoryBtn.style.display = 'none';
                return;
            }
            
            historicoFiltrado = dadosParaRenderizar.filter(transacao => {
                return !filtroPixAtivo || transacao.pagamento === 'PIX';
            });
            
            const historicoInvertido = [...historicoFiltrado].reverse();
            
            historicoInvertido.forEach((transacao, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                if (index >= 4) {
                    historyItem.classList.add('hidden');
                }
                historyItem.innerHTML = `
                    <div class="history-item-info">
                        <span>${transacao.data}</span>
                        <span>${transacao.pagamento}</span>
                    </div>
                    <span class="history-item-price">R$ ${transacao.total.toFixed(2).replace('.', ',')}</span>
                `;
                historyList.appendChild(historyItem);
                totalHistorico += transacao.total;
            });

            if (historicoFiltrado.length > 4) {
                showHideHistoryBtn.style.display = 'block';
            } else {
                showHideHistoryBtn.style.display = 'none';
            }

            totalHistoricoSpan.textContent = `R$ ${totalHistorico.toFixed(2).replace('.', ',')}`;
        }

        filterPixBtn.addEventListener('click', () => {
            filtroPixAtivo = !filtroPixAtivo;
            filterPixBtn.classList.toggle('active', filtroPixAtivo);
            renderizarHistorico();
        });

        filterOntemBtn.addEventListener('click', () => {
            if (turnoStartTime) {
                alert("O filtro 'Ontem' só mostra o histórico do ÚLTIMO turno FINALIZADO. Finalize o turno atual para ver o anterior.");
                return;
            }
            filtroOntemAtivo = !filtroOntemAtivo;
            filterOntemBtn.classList.toggle('active', filtroOntemAtivo);
            renderizarHistorico();
            excluirUltimaVendaBtn.disabled = filtroOntemAtivo;
            baixarHistoricoBtn.disabled = filtroOntemAtivo;
            
            if (filtroOntemAtivo) {
                 alert("Mostrando vendas do último turno FINALIZADO.");
            }
        });

        function renderizarSaques() {
            saquesList.innerHTML = '';
            let totalSaques = 0;
            saquesTurno.forEach(saque => {
                const saqueItem = document.createElement('div');
                saqueItem.className = 'saque-item';
                saqueItem.innerHTML = `
                    <span>${saque.data}</span>
                    <span style="color: #dc3545;">- R$ ${saque.valor.toFixed(2).replace('.', ',')}</span>
                `;
                saquesList.prepend(saqueItem);
                totalSaques += saque.valor;
            });
            totalSaquesSpan.textContent = `R$ ${totalSaques.toFixed(2).replace('.', ',')}`;
        }

        function atualizarTotalDoDia() {
            const totalVendas = historicoTurno.reduce((sum, transacao) => sum + transacao.total, 0);
            const totalSaques = saquesTurno.reduce((sum, saque) => sum + saque.valor, 0);
            const totalDia = totalVendas - totalSaques;
            totalDoDiaSpan.textContent = `R$ ${totalDia.toFixed(2).replace('.', ',')}`;
        }

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'historico') {
                renderizarHistorico();
                renderizarSaques();
                historicoCompletoDiv.style.display = 'none';
            }
        }

        function toggleHistory() {
            const hiddenItems = document.querySelectorAll('#historyList .history-item.hidden');
            if (historicoVisivel) {
                hiddenItems.forEach(item => item.style.display = 'none');
                showHideHistoryBtn.textContent = 'Mostrar mais';
            } else {
                hiddenItems.forEach(item => item.style.display = 'flex');
                showHideHistoryBtn.textContent = 'Mostrar menos';
            }
            historicoVisivel = !historicoVisivel;
        }

        showHideHistoryBtn.addEventListener('click', toggleHistory);

        valorInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2);
            valorInput.value = value.replace('.', ',');
        });

        saqueInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2);
            saqueInput.value = value.replace('.', ',');
        });

        window.addEventListener('load', () => {
            loadState();
            renderizarCarrinho();
            renderizarHistorico();
            renderizarSaques();
            atualizarTotalDoDia();
        });

    </script>
</body>
</html>
