<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title> M&A Caixa</title>
    <style>
        /* Estilos CSS */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .header-bar button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .header-bar button:hover {
            background-color: #0056b3;
        }
        .total-do-dia {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }
        .container {
            flex: 1;
            display: flex;
            padding: 10px;
        }
        .page {
            display: none;
            width: 100%;
            height: 100%;
        }
        .page.active {
            display: flex;
        }
        .caixa-main {
            flex: 2;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            margin-right: 10px;
            overflow: hidden;
        }
        .caixa-sidebar {
            flex: 1;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .quick-values {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            max-height: 40%;
            overflow-y: auto;
        }
        .quick-value-button {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            flex: 1 1 20%;
            min-width: 60px;
            text-align: center;
        }
        .input-valor {
            width: 100%;
            padding: 10px;
            font-size: 2rem;
            text-align: right;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .cart-list, .history-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-price {
            font-weight: bold;
        }
        .cart-item-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .cart-summary {
            border-top: 2px solid #eee;
            padding-top: 10px;
        }
        .cart-summary .total {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-weight: bold;
            color: #218838;
        }
        .payment-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .payment-button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 0.9rem;
            flex-grow: 1;
            margin: 0 4px;
        }
        .checkout-button {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .checkout-button:hover {
            background-color: #218838;
        }
        .history-main {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .history-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .history-actions button {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #iniciarTurnoBtn { background-color: #28a745; }
        #finalizarTurnoBtn { background-color: #dc3545; }
        #baixarHistoricoBtn { background-color: #007bff; }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .history-item-info span {
            display: block;
            color: #666;
        }
        .turno-status {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
        }
        /* Estilos para o Modal (Pop-up) de Troco */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3, .modal-content p {
            margin: 0 0 10px 0;
        }
        .modal-content h3 {
            font-size: 1.5rem;
        }
        .modal-content .valor-display {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            font-size: 1.5rem;
            text-align: right;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            margin: 10px 0;
        }
        .modal-content .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .modal-content .modal-buttons button {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
            margin: 0 5px;
        }
        #finalizarTrocoBtn { background-color: #28a745; color: #fff; border: none; }
        #finalizarTrocoBtn:hover { background-color: #218838; }
        #cancelarTrocoBtn { background-color: #dc3545; color: #fff; border: none; }
        #cancelarTrocoBtn:hover { background-color: #c82333; }
        #exatoBtn { background-color: #6c757d; color: #fff; border: none; }
        #exatoBtn:hover { background-color: #5a6268; }
    </style>
</head>
<body>

    <div class="header-bar">
        <button onclick="showPage('caixa')">Caixa M&A </button>
        <button onclick="showPage('historico')">Histórico</button>
        <div class="total-do-dia">Total do Turno: <span id="totalDoDia">R$ 0,00</span></div>
    </div>

    <div id="caixa" class="page active container">
        <div class="caixa-main">
            <div class="quick-values" id="quickValues"></div>
            <input type="text" id="valorInput" class="input-valor" placeholder="0,00" value="0,00">
            <button id="adicionarButton" class="checkout-button" style="background-color: #007bff; margin-top: 0;">Adicionar</button>
        </div>
        
        <div class="caixa-sidebar">
            <h2 style="font-size: 1.2rem; margin-top: 0;">Transação</h2>
            <div id="cartList" class="cart-list"></div>
            <div class="cart-summary">
                <div class="total">
                    <span>Total:</span>
                    <span id="cartTotal">R$ 0,00</span>
                </div>
                <div class="payment-buttons">
                    <button class="payment-button active" data-type="Dinheiro">Dinheiro</button>
                    <button class="payment-button" data-type="Cartão">Cartão</button>
                    <button class="payment-button" data-type="PIX">PIX</button>
                </div>
                <button id="finalizarButton" class="checkout-button">Finalizar Venda</button>
            </div>
        </div>
    </div>

    <div id="historico" class="page container">
        <div class="history-main">
            <div class="history-actions">
                <button id="iniciarTurnoBtn" style="background-color: #28a745;">Iniciar Turno</button>
                <button id="finalizarTurnoBtn" style="background-color: #dc3545;">Finalizar Turno</button>
            </div>
            <div class="turno-status">Turno iniciado: <span id="turnoStartTime">N/A</span> | Tempo de trabalho: <span id="workTime">00:00:00</span></div>
            <h2 style="font-size: 1.2rem; margin-top: 0;">Histórico de Vendas</h2>
            <div id="historyList" class="history-list"></div>
            <div class="history-actions" style="justify-content: center;">
                <button id="baixarHistoricoBtn" style="background-color: #007bff;">Baixar Histórico (Excel)</button>
            </div>
            <div class="total-historico">
                <h3 style="font-size: 1rem;">Total do Histórico: <span id="totalHistorico">R$ 0,00</span></h3>
            </div>
        </div>
    </div>

    <div id="trocoModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Calcular Troco</h3>
            <p>Total da venda: <span class="valor-display" id="modalTotal">R$ 0,00</span></p>
            <p>Valor recebido:</p>
            <input type="text" id="valorRecebidoInput" placeholder="0,00">
            <div class="modal-buttons">
                <button id="exatoBtn">Exato</button>
                <button id="finalizarTrocoBtn">Finalizar</button>
            </div>
            <p style="margin-top: 10px;">Troco: <span class="valor-display" id="modalTroco">R$ 0,00</span></p>
            <button id="cancelarTrocoBtn" style="margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <script>
        let carrinho = [];
        let historicoTurno = [];
        let historicoCompleto = [];
        let tipoPagamento = 'Dinheiro';
        let turnoStartTime = null;
        let workTimeInterval;

        const pages = document.querySelectorAll('.page');
        const valorInput = document.getElementById('valorInput');
        const adicionarButton = document.getElementById('adicionarButton');
        const cartList = document.getElementById('cartList');
        const cartTotal = document.getElementById('cartTotal');
        const finalizarButton = document.getElementById('finalizarButton');
        const paymentButtons = document.querySelectorAll('.payment-button');
        const quickValuesContainer = document.getElementById('quickValues');
        const historyList = document.getElementById('historyList');
        const totalHistoricoSpan = document.getElementById('totalHistorico');
        const totalDoDiaSpan = document.getElementById('totalDoDia');
        const iniciarTurnoBtn = document.getElementById('iniciarTurnoBtn');
        const finalizarTurnoBtn = document.getElementById('finalizarTurnoBtn');
        const baixarHistoricoBtn = document.getElementById('baixarHistoricoBtn');
        const turnoStartTimeSpan = document.getElementById('turnoStartTime');
        const workTimeSpan = document.getElementById('workTime');
        const trocoModal = document.getElementById('trocoModal');
        const modalTotalSpan = document.getElementById('modalTotal');
        const valorRecebidoInput = document.getElementById('valorRecebidoInput');
        const modalTrocoSpan = document.getElementById('modalTroco');
        const exatoBtn = document.getElementById('exatoBtn');
        const finalizarTrocoBtn = document.getElementById('finalizarTrocoBtn');
        const cancelarTrocoBtn = document.getElementById('cancelarTrocoBtn');

        const quickValues = [1.50, 2, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];

        function saveState() {
            localStorage.setItem('historicoTurno', JSON.stringify(historicoTurno));
            localStorage.setItem('historicoCompleto', JSON.stringify(historicoCompleto));
            localStorage.setItem('turnoStartTime', turnoStartTime);
        }

        function loadState() {
            const savedHistoricoTurno = localStorage.getItem('historicoTurno');
            const savedHistoricoCompleto = localStorage.getItem('historicoCompleto');
            const savedTurnoStartTime = localStorage.getItem('turnoStartTime');

            if (savedHistoricoTurno) {
                historicoTurno = JSON.parse(savedHistoricoTurno);
            }
            if (savedHistoricoCompleto) {
                historicoCompleto = JSON.parse(savedHistoricoCompleto);
            }
            if (savedTurnoStartTime !== 'null') {
                turnoStartTime = savedTurnoStartTime;
                startWorkTimeCounter();
            }
        }

        function updateWorkTime() {
            if (turnoStartTime) {
                const now = new Date().getTime();
                const diff = now - parseInt(turnoStartTime);
                const seconds = Math.floor(diff / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;

                const pad = (num) => num.toString().padStart(2, '0');
                workTimeSpan.textContent = `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;
            }
        }

        function startWorkTimeCounter() {
            clearInterval(workTimeInterval);
            turnoStartTimeSpan.textContent = new Date(parseInt(turnoStartTime)).toLocaleString('pt-BR');
            workTimeInterval = setInterval(updateWorkTime, 1000);
        }

        function stopWorkTimeCounter() {
            clearInterval(workTimeInterval);
            workTimeSpan.textContent = '00:00:00';
            turnoStartTimeSpan.textContent = 'N/A';
        }

        quickValues.forEach(valor => {
            const button = document.createElement('button');
            button.className = 'quick-value-button';
            button.textContent = `R$ ${valor.toFixed(2).replace('.', ',')}`;
            button.addEventListener('click', () => {
                let valorAtual = parseFloat(valorInput.value.replace(',', '.')) || 0;
                valorAtual += valor;
                valorInput.value = valorAtual.toFixed(2).replace('.', ',');
            });
            quickValuesContainer.appendChild(button);
        });

        adicionarButton.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Por favor, inicie um turno antes de adicionar vendas.");
                return;
            }

            let valor = parseFloat(valorInput.value.replace(',', '.'));
            if (isNaN(valor) || valor <= 0) {
                alert("Por favor, insira um valor válido.");
                return;
            }
            carrinho.push(valor);
            renderizarCarrinho();
            valorInput.value = '0,00';
        });

        paymentButtons.forEach(button => {
            button.addEventListener('click', () => {
                paymentButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tipoPagamento = button.dataset.type;
            });
        });

        finalizarButton.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Por favor, inicie um turno antes de finalizar vendas.");
                return;
            }
            if (carrinho.length === 0) {
                alert("O carrinho está vazio. Adicione itens para finalizar a venda.");
                return;
            }

            if (tipoPagamento === 'Dinheiro') {
                const total = carrinho.reduce((sum, item) => sum + item, 0);
                modalTotalSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                valorRecebidoInput.value = ''; // Limpa o campo
                modalTrocoSpan.textContent = `R$ 0,00`;
                trocoModal.style.display = 'flex';
                valorRecebidoInput.focus();
            } else {
                finalizarVendaReal();
            }
        });

        valorRecebidoInput.addEventListener('input', (e) => {
            let valorRecebido = parseFloat(e.target.value.replace(',', '.')) || 0;
            const total = parseFloat(cartTotal.textContent.replace('R$ ', '').replace(',', '.'));
            const troco = valorRecebido - total;
            modalTrocoSpan.textContent = `R$ ${troco.toFixed(2).replace('.', ',')}`;
        });

        exatoBtn.addEventListener('click', () => {
            const total = parseFloat(cartTotal.textContent.replace('R$ ', '').replace(',', '.'));
            valorRecebidoInput.value = total.toFixed(2).replace('.', ',');
            modalTrocoSpan.textContent = `R$ 0,00`;
        });

        finalizarTrocoBtn.addEventListener('click', () => {
            const valorRecebido = parseFloat(valorRecebidoInput.value.replace(',', '.'));
            const total = parseFloat(cartTotal.textContent.replace('R$ ', '').replace(',', '.'));

            if (isNaN(valorRecebido) || valorRecebido < total) {
                alert("O valor recebido é inválido ou menor que o total. Por favor, corrija.");
                return;
            }

            finalizarVendaReal();
            trocoModal.style.display = 'none';
        });

        cancelarTrocoBtn.addEventListener('click', () => {
            trocoModal.style.display = 'none';
        });
        
        function finalizarVendaReal() {
            const total = carrinho.reduce((sum, item) => sum + item, 0);
            const dataVenda = new Date().toLocaleString('pt-BR');
            const transacao = { total, pagamento: tipoPagamento, data: dataVenda };
            historicoTurno.push(transacao);
            carrinho = [];
            renderizarCarrinho();
            atualizarTotalDoDia();
            saveState();
            alert(`Venda finalizada com sucesso!\nTotal: R$ ${total.toFixed(2).replace('.', ',')}\nPagamento: ${tipoPagamento}`);
        }

        iniciarTurnoBtn.addEventListener('click', () => {
            historicoTurno = [];
            turnoStartTime = new Date().getTime();
            saveState();
            startWorkTimeCounter();
            alert("Novo turno iniciado! O caixa foi zerado.");
            renderizarHistorico();
            atualizarTotalDoDia();
        });

        finalizarTurnoBtn.addEventListener('click', () => {
            if (!turnoStartTime) {
                alert("Nenhum turno em andamento para finalizar.");
                return;
            }
            const totalTurno = historicoTurno.reduce((sum, transacao) => sum + transacao.total, 0);
            historicoCompleto.unshift({
                data: new Date().toLocaleString('pt-BR'),
                total: totalTurno,
                vendas: [...historicoTurno]
            });
            alert(`Turno finalizado! Total de vendas do turno: R$ ${totalTurno.toFixed(2).replace('.', ',')}.`);
            
            historicoTurno = [];
            turnoStartTime = null;
            saveState();
            stopWorkTimeCounter();
            renderizarHistorico();
            atualizarTotalDoDia();
        });

        baixarHistoricoBtn.addEventListener('click', () => {
            if (historicoTurno.length === 0) {
                alert("Não há histórico de vendas para baixar.");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data e Hora,Valor,Forma de Pagamento\n";

            historicoTurno.forEach(transacao => {
                const row = [
                    `"${transacao.data}"`,
                    `"${transacao.total.toFixed(2).replace('.', ',')}"`,
                    `"${transacao.pagamento}"`
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historico_vendas.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function renderizarCarrinho() {
            cartList.innerHTML = '';
            let total = 0;
            if (carrinho.length === 0) {
                cartList.innerHTML = '<p style="text-align: center; color: #888; font-size: 0.9rem;">Carrinho vazio</p>';
            } else {
                carrinho.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'cart-item';
                    listItem.innerHTML = `
                        <span class="cart-item-price">R$ ${item.toFixed(2).replace('.', ',')}</span>
                        <button class="cart-item-remove" data-index="${index}">×</button>
                    `;
                    cartList.appendChild(listItem);
                    total += item;
                });
                document.querySelectorAll('.cart-item-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = e.target.getAttribute('data-index');
                        carrinho.splice(index, 1);
                        renderizarCarrinho();
                    });
                });
            }
            cartTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            saveState();
        }

        function renderizarHistorico() {
            historyList.innerHTML = '';
            let totalHistorico = 0;
            historicoTurno.forEach(transacao => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-info">
                        <span>${transacao.data}</span>
                        <span>${transacao.pagamento}</span>
                    </div>
                    <span class="history-item-price">R$ ${transacao.total.toFixed(2).replace('.', ',')}</span>
                `;
                historyList.prepend(historyItem);
                totalHistorico += transacao.total;
            });
            totalHistoricoSpan.textContent = `R$ ${totalHistorico.toFixed(2).replace('.', ',')}`;
        }

        function atualizarTotalDoDia() {
            const total = historicoTurno.reduce((sum, transacao) => sum + transacao.total, 0);
            totalDoDiaSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'historico') {
                renderizarHistorico();
            }
        }

        valorInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2);
            valorInput.value = value.replace('.', ',');
        });

        window.addEventListener('load', () => {
            loadState();
            renderizarCarrinho();
            renderizarHistorico();
            atualizarTotalDoDia();
        });

    </script>
</body>
</html>
